<!-- Generated by Ruler -->


<!-- Source: .ruler/AGENTS.md -->

# Context Terraform Provider

## Overview

This Terraform provider replicates the functionality of the `kbrockhoff/terraform-external-context` module. The provider should generate the same three primary outputs: `name_prefix`, `tags`, and `data_tags` while providing a more native Terraform experience.

## Provider Schema Requirements

### Provider Configuration

The provider should accept the following configuration attributes:

#### Core Configuration
- `cloud_provider` (string, optional) - Cloud provider identifier: `dc`, `aws`, `az`, `gcp`, `oci`, `ibm`, `do`, `vul`, `ali`, `cv`
- `tag_prefix` (string, optional, default: "bc-") - Prefix for all generated tags

#### Naming Configuration
- `namespace` (string, optional) - Organization or business unit identifier (1-8 chars, lowercase alphanumeric with hyphens)
- `name` (string, optional) - Unique resource name (combined name_prefix must be 2-24 chars)
- `environment` (string, optional) - Environment abbreviation (1-8 chars, lowercase alphanumeric with hyphens)
- `environment_name` (string, optional) - Full environment name
- `environment_type` (string, optional) - One of: None, Ephemeral, Development, Testing, UAT, Production, MissionCritical

#### Resource Management
- `enabled` (bool, optional, default: true) - Enable/disable resource creation
- `availability` (string, optional, default: "preemptable") - Availability requirement from predefined list
- `managedby` (string, optional, default: "terraform") - Management platform identifier
- `deletion_date` (string, optional) - Resource deletion date (YYYY-MM-DD format)

#### Project Management Integration
- `pm_platform` (string, optional) - Project management platform (e.g., JIRA, SNOW)
- `pm_project_code` (string, optional) - Project code/prefix

#### ITSM Integration
- `itsm_platform` (string, optional) - IT Service Management platform
- `itsm_system_id` (string, optional) - ITSM system identifier
- `itsm_component_id` (string, optional) - ITSM component identifier
- `itsm_instance_id` (string, optional) - ITSM instance identifier

#### Ownership and Billing
- `cost_center` (string, optional) - Cost center for billing
- `product_owners` (list(string), optional) - Product owner email addresses
- `code_owners` (list(string), optional) - Code owner email addresses
- `data_owners` (list(string), optional) - Data owner email addresses

#### Data Classification
- `sensitivity` (string, optional, default: "confidential") - Data sensitivity level from predefined list
- `data_regs` (list(string), optional) - Data compliance regulations
- `security_review` (string, optional) - Security review identifier/date
- `privacy_review` (string, optional) - Privacy review identifier/date

#### Feature Toggles
- `source_repo_tags_enabled` (bool, optional, default: true) - Include git repository tags
- `system_prefixes_enabled` (bool, optional, default: true) - Add platform prefixes to system IDs
- `not_applicable_enabled` (bool, optional, default: true) - Include N/A tags for null values
- `owner_tags_enabled` (bool, optional, default: true) - Include owner tags

#### Additional Tags
- `additional_tags` (map(string), optional) - Custom tags to merge
- `additional_data_tags` (map(string), optional) - Custom data-specific tags to merge

## Data Source Requirements

### Context Data Source

The provider should include a `context` data source that provides the computed outputs:

```hcl
data "brockhoff_context" "main" {
  namespace    = "myorg"
  name         = "myapp"
  environment  = "prod"
  # ... other attributes
}
```

## Computed Attributes

### Primary Outputs

1. **name_prefix** (string) - Computed name prefix following Brockhoff standards:
   - Format: `namespace-name-environment` or just `name` if namespace/environment are null
   - Must match regex: `/^[a-z][a-z0-9-]{0,22}[a-z0-9]$/`
   - Maximum 24 characters with intelligent truncation

2. **tags** (map(string)) - Normalized tag map including:
   - Environment and availability tags
   - Management and ownership tags
   - Project management and ITSM tags
   - Source repository information (if enabled)
   - Custom additional tags

3. **data_tags** (map(string)) - Data-specific tags including:
   - Data sensitivity classification
   - Data owner information
   - Data regulation compliance tags
   - Custom additional data tags

### Additional Outputs

4. **tags_as_list_of_maps** (list(object)) - Tags formatted for AWS resources
5. **tags_as_kvp_list** (list(string)) - Tags as key=value pairs
6. **tags_as_comma_separated_string** (string) - Tags as comma-separated string
7. **data_tags_as_list_of_maps** (list(object)) - Data tags formatted for AWS resources
8. **data_tags_as_kvp_list** (list(string)) - Data tags as key=value pairs  
9. **data_tags_as_comma_separated_string** (string) - Data tags as comma-separated string

## Business Logic Requirements

### Name Prefix Generation

1. **Standard Format**: If `namespace`, `name`, and `environment` are all provided:
   - Combine as: `namespace-name-environment`
   - Convert to lowercase
   
2. **Name-Only Format**: If `namespace` or `environment` are null:
   - Use only the `name` value
   
3. **Length Validation**: Ensure final prefix matches `/^[a-z][a-z0-9-]{0,22}[a-z0-9]$/`
   - Maximum 24 characters total
   - If too long, truncate the `name` component to fit

### Cloud Provider Constraints

Apply different tag formatting rules based on `cloud_provider`:

- **AWS**: 256 char limit, replace `/[^a-zA-Z0-9 \\.:=+@_/-]/` with `_`, delimiter: ` `
- **Azure**: 256 char limit, replace `/[ <>%&\\?/#:]/` with `""`, delimiter: `;`, N/A: "NotApplicable"  
- **GCP**: 63 char limit, lowercase tags, replace `/[^a-z0-9_-]/` with `-`, delimiter: `_`, N/A: "not_applicable"
- **Default/DC**: 63 char limit, replace `/[<>%&\\?]/` with `_`, delimiter: `;`

### Tag Processing

1. **Conditional Tags**: Only include tags when:
   - Values are non-null OR `not_applicable_enabled` is true
   - Feature flags are enabled (e.g., `owner_tags_enabled`)

2. **System Prefixes**: When `system_prefixes_enabled` is true:
   - Prepend platform names to ITSM and PM codes
   - Format: `platform<delimiter>code`

3. **Git Repository Integration**: When `source_repo_tags_enabled` is true:
   - Execute git commands to get repository URL and commit hash
   - Convert SSH URLs to HTTPS format
   - Include `sourcerepo` and `sourcecommit` tags

### Ephemeral Environment Handling

For `environment_type = "Ephemeral"`:
- Auto-calculate deletion date as 90 days (2160 hours) from creation
- Override any manually set `deletion_date`

### Validation Requirements

1. **Input Validation**: 
   - Validate cloud provider against allowed list
   - Validate environment type against allowed list
   - Validate name patterns and lengths
   - Validate sensitivity and availability against allowed values

2. **Output Validation**:
   - Ensure name_prefix matches required regex pattern
   - Apply cloud provider-specific tag constraints
   - Truncate tag values that exceed length limits

## Implementation Considerations

### State Management
- The provider should be stateless and re-compute outputs on each plan/apply
- Git repository information should be fetched during plan phase
- Consider caching git information to avoid repeated calls

### Error Handling
- Gracefully handle missing git repository information
- Provide clear error messages for validation failures
- Support partial functionality when optional features fail

### Performance
- Minimize external command execution
- Cache computed values during single terraform run
- Avoid blocking operations where possible

### Backwards Compatibility
- Maintain exact output compatibility with existing module
- Support all existing input parameters and validation rules
- Preserve tag formatting and naming conventions

## Testing Requirements

The provider should include comprehensive tests covering:

1. **Unit Tests**: All business logic functions
2. **Integration Tests**: End-to-end data source functionality  
3. **Cloud Provider Tests**: Validation of cloud-specific constraints
4. **Edge Cases**: Truncation, missing inputs, invalid configurations
5. **Git Integration Tests**: Repository information extraction

## Documentation Requirements

1. **Provider Documentation**: Complete attribute reference
2. **Data Source Documentation**: Usage examples and output descriptions
3. **Migration Guide**: Instructions for migrating from existing module
4. **Examples**: Common usage patterns and configurations
